#!/usr/bin/python3

import wave
import struct

from argparse import ArgumentParser


def get_args():
    parser = ArgumentParser()
    parser.add_argument('--out', help='output filename', required=True)
    parser.add_argument('--file', help='wav with hidden flag', required=True)
    return parser.parse_args()


def unpack_amp(data):
    return struct.unpack('<h', data)[0]


def pack_amp(amp):
    return struct.pack('<h', amp)


if __name__ == '__main__':
    args = get_args()

    with wave.open(args.file, 'rb') as wav:
        frames = wav.readframes(wav.getnframes())
    
    amps = [unpack_amp(frames[i:i+2]) for i in range(0, len(frames), 2)]
    diffs = [amps[i + 1] - amps[i] for i in range(0, len(amps), 2)]
    result = [pack_amp(diff * 500) for diff in diffs]
    
    with wave.open(args.out, 'wb') as wav:
        wav.setsampwidth(2)
        wav.setnchannels(1)
        wav.setframerate(8000)
        wav.writeframes(b''.join(result))
